<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Analytics</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <%- include('../partials/navbar', { user: user }) %>

  <section class="sa-hero">
    <div class="container">
      <div class="eyebrow">Analytics</div>
      <h1>Store overview.</h1>
      <p>Top products, revenue, and recent orders framed in a clean supermarket dashboard.</p>
    </div>
  </section>

  <main class="container page-shell">
    <h3 class="mb-4">Sales Analytics</h3>

    <% if (messages && messages.error && messages.error.length) { %>
      <div class="alert alert-danger"><%= messages.error[0] %></div>
    <% } %>
    <% if (messages && messages.success && messages.success.length) { %>
      <div class="alert alert-success"><%= messages.success[0] %></div>
    <% } %>

    <div class="card mb-4">
      <div class="card-header"><h5 class="mb-0">Top 10 Products by Quantity Sold</h5></div>
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Product</th>
              <th style="width:120px">Total Qty</th>
              <th style="width:120px">Orders</th>
            </tr>
          </thead>
          <tbody>
            <% topByQty.forEach(p => { %>
              <tr>
                <td><%= p.productName %></td>
                <td><%= p.totalQty %></td>
                <td><%= p.orderCount %></td>
              </tr>
            <% }) %>
            <% if (topByQty.length === 0) { %>
              <tr><td colspan="3" class="text-center text-muted">No data</td></tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header"><h5 class="mb-0">Top 10 Products by Revenue</h5></div>
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Product</th>
              <th style="width:140px">Total Revenue</th>
              <th style="width:120px">Units Sold</th>
            </tr>
          </thead>
          <tbody>
            <% topByRevenue.forEach(p => { %>
              <tr>
                <td><%= p.productName %></td>
                <td>$<%= Number(p.totalRevenue).toFixed(2) %></td>
                <td><%= p.totalQty %></td>
              </tr>
            <% }) %>
            <% if (topByRevenue.length === 0) { %>
              <tr><td colspan="3" class="text-center text-muted">No data</td></tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">Orders</h4>
      <form action="/admin/orders/delete-all" method="POST" onsubmit="return confirm('Delete ALL orders and items?');">
        <button class="btn btn-outline-danger btn-sm">Delete All Orders</button>
      </form>
    </div>

    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Recent 20 Orders</h5>
        <small class="text-muted">Delete an item to update totals; delete order removes all items.</small>
      </div>
      <div class="card-body p-0">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th style="width:80px">Order ID</th>
              <th>Username</th>
              <th style="width:120px">Total</th>
              <th style="width:100px">Items</th>
              <th style="width:180px">Date</th>
              <th style="width:140px">Manage</th>
            </tr>
          </thead>
          <tbody>
            <% recentOrders.forEach(o => { %>
              <tr class="table-group-divider">
                <td><%= o.id %></td>
                <td><%= o.username || 'N/A' %></td>
                <td>$<%= Number(o.total).toFixed(2) %></td>
                <td><%= o.itemCount %></td>
                <td><small><%= new Date(o.created_at).toLocaleString() %></small></td>
                <td>
                  <div class="btn-group btn-group-sm" role="group">
                    <a class="btn btn-outline-primary" href="/admin/orders/<%= o.id %>/edit">Edit</a>
                    <form action="/admin/orders/<%= o.id %>/delete" method="POST" onsubmit="return confirm('Delete order #<%= o.id %> ?');" class="m-0">
                      <button class="btn btn-outline-danger">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
              <% const items = (orderItems && orderItems[o.id]) ? orderItems[o.id] : []; %>
              <% if (items.length) { %>
                <tr>
                  <td colspan="6" class="bg-light">
                    <div class="table-responsive">
                      <table class="table table-sm mb-0">
                        <thead>
                          <tr>
                            <th style="width:80px">Item ID</th>
                            <th>Product</th>
                            <th style="width:80px">Qty</th>
                            <th style="width:110px">Unit (after disc)</th>
                            <th style="width:110px">Subtotal</th>
                            <th style="width:140px">Action</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% items.forEach(it => { %>
                            <tr>
                              <td><%= it.id %></td>
                              <td><%= it.productName %> (#<%= it.productId %>)</td>
                              <td><%= it.quantity %></td>
                              <td>$<%= Number(it.unit_price_after_discount).toFixed(2) %></td>
                              <td>$<%= Number(it.subtotal).toFixed(2) %></td>
                              <td>
                                <div class="btn-group btn-group-sm" role="group">
                                  <form action="/admin/orders/<%= o.id %>/items/<%= it.id %>/delete" method="POST" onsubmit="return confirm('Delete item #<%= it.id %> from order #<%= o.id %>?');" class="m-0">
                                    <button class="btn btn-outline-danger">Delete</button>
                                  </form>
                                </div>
                              </td>
                            </tr>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                  </td>
                </tr>
              <% } else { %>
                <tr>
                  <td colspan="6" class="bg-light text-muted text-center small">No items found for this order.</td>
                </tr>
              <% } %>
            <% }) %>
            <% if (recentOrders.length === 0) { %>
              <tr><td colspan="6" class="text-center text-muted">No orders yet</td></tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
