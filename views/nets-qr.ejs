<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NETS QR Payment</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <%- include('partials/navbar', { user: user }) %>

  <section class="sa-hero">
    <div class="container">
      <div class="eyebrow">NETS QR</div>
      <h1>Scan to complete your payment.</h1>
      <p>Scan the QR code with your banking app. This page will update automatically.</p>
    </div>
  </section>

  <main class="container page-shell">
    <div class="row g-4 align-items-center">
      <div class="col-lg-6">
        <div class="panel">
          <div class="panel-header">
            <strong>Amount due</strong>
          </div>
          <div class="panel-body">
            <h2 class="mb-2">$<%= Number(total).toFixed(2) %></h2>
            <p class="mb-0 muted-text" id="status">Waiting for scan...</p>
            <p class="mt-3 mb-0"><strong id="timer">Time remaining: 5:00</strong></p>
          </div>
        </div>
      </div>
      <div class="col-lg-6 text-center">
        <div class="panel light p-3">
          <img class="img-fluid" alt="NETS QR Code" src="data:image/png;base64,<%= qrCodeBase64 %>">
        </div>
        <div class="mt-3">
          <a class="btn btn-outline-primary" href="/checkout">Cancel</a>
        </div>
      </div>
    </div>
  </main>

  <script>
    const txnRetrievalRef = "<%= txnRetrievalRef %>";
    const statusEl = document.getElementById('status');
    const timerElement = document.getElementById('timer');

    const eventSource = new EventSource(`/sse/payment-status/${txnRetrievalRef}`);

    eventSource.addEventListener('message', (event) => {
      const data = JSON.parse(event.data);
      if (data && data.success) {
        eventSource.close();
        window.location.href = '/nets-qr/success';
        return;
      }
      if (data && data.fail) {
        eventSource.close();
        window.location.href = '/nets-qr/fail';
        return;
      }
    });

    eventSource.addEventListener('error', () => {
      statusEl.textContent = 'Connection lost. Please refresh if this persists.';
    });

    let remainingTime = 300;
    const updateTimer = () => {
      const minutes = Math.floor(remainingTime / 60);
      const seconds = remainingTime % 60;
      timerElement.textContent = `Time remaining: ${minutes}:${seconds.toString().padStart(2, '0')}`;
      remainingTime -= 1;
      if (remainingTime < 0) {
        clearInterval(timerInterval);
        statusEl.textContent = 'Transaction timed out.';
        if (eventSource) eventSource.close();
        window.location.href = '/nets-qr/fail';
      }
    };

    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer();
  </script>
</body>
</html>
